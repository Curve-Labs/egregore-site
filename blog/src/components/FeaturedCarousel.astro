---
import type { CollectionEntry } from 'astro:content';

interface Props {
  posts: CollectionEntry<'posts'>[];
}

const { posts } = Astro.props;
---

<div class="carousel" data-carousel>
  <div class="carousel-track">
    {posts.map((post, index) => {
      const { title, subtitle, date, readTime, category, author } = post.data;
      return (
        <article class="carousel-slide" data-index={index} class:list={{ active: index === 0 }}>
          <a href={`/${post.slug}/`} class="featured-link">
            <div class="featured-content">
              <div class="featured-meta">
                <span class="category">{category}</span>
                <span class="divider">•</span>
                <time datetime={date.toISOString()}>
                  {date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                </time>
                <span class="divider">•</span>
                <span class="read-time">{readTime}</span>
              </div>

              <h2 class="featured-title">{title}</h2>
              <p class="featured-subtitle">{subtitle}</p>

              <div class="featured-author">
                <span class="author-label">by</span>
                <span class="author-name">{author}</span>
              </div>
            </div>

            <div class="featured-indicator">
              <span class="indicator-text">Featured</span>
              <span class="indicator-arrow">→</span>
            </div>
          </a>
        </article>
      );
    })}
  </div>

  {posts.length > 1 && (
    <div class="carousel-controls">
      <div class="carousel-dots">
        {posts.map((_, index) => (
          <button
            type="button"
            class:list={['carousel-dot', { active: index === 0 }]}
            data-dot={index}
            aria-label={`Go to slide ${index + 1}`}
          />
        ))}
      </div>
      <div class="carousel-nav">
        <button type="button" class="carousel-btn" data-prev aria-label="Previous slide">←</button>
        <button type="button" class="carousel-btn" data-next aria-label="Next slide">→</button>
      </div>
    </div>
  )}
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    var carousel = document.querySelector('[data-carousel]');
    if (!carousel) return;

    var slides = carousel.querySelectorAll('.carousel-slide');
    var dots = carousel.querySelectorAll('.carousel-dot');
    var prevBtn = carousel.querySelector('[data-prev]');
    var nextBtn = carousel.querySelector('[data-next]');
    var currentIndex = 0;
    var autoplayInterval;

    function goToSlide(index) {
      // Wrap around
      if (index < 0) index = slides.length - 1;
      if (index >= slides.length) index = 0;

      // Update slides
      slides.forEach(function(slide, i) {
        slide.classList.remove('active');
        slide.style.opacity = '0';
        slide.style.transform = 'translateX(20px)';
      });

      var activeSlide = slides[index];
      activeSlide.classList.add('active');
      setTimeout(function() {
        activeSlide.style.opacity = '1';
        activeSlide.style.transform = 'translateX(0)';
      }, 50);

      // Update dots
      dots.forEach(function(dot, i) {
        dot.classList.toggle('active', i === index);
      });

      currentIndex = index;
    }

    function nextSlide() {
      goToSlide(currentIndex + 1);
    }

    function prevSlide() {
      goToSlide(currentIndex - 1);
    }

    function startAutoplay() {
      autoplayInterval = setInterval(nextSlide, 6000);
    }

    function stopAutoplay() {
      clearInterval(autoplayInterval);
    }

    // Event listeners
    if (prevBtn) prevBtn.addEventListener('click', function() { stopAutoplay(); prevSlide(); startAutoplay(); });
    if (nextBtn) nextBtn.addEventListener('click', function() { stopAutoplay(); nextSlide(); startAutoplay(); });

    dots.forEach(function(dot, i) {
      dot.addEventListener('click', function() {
        stopAutoplay();
        goToSlide(i);
        startAutoplay();
      });
    });

    // Pause on hover
    carousel.addEventListener('mouseenter', stopAutoplay);
    carousel.addEventListener('mouseleave', startAutoplay);

    // Initialize
    goToSlide(0);
    startAutoplay();
  });
</script>

<style>
  .carousel {
    position: relative;
  }

  .carousel-track {
    position: relative;
  }

  .carousel-slide {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    opacity: 0;
    pointer-events: none;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: opacity 300ms ease, transform 300ms ease, border-color 200ms ease, box-shadow 200ms ease;
    transform: translateX(20px);
  }

  /* First slide is relative to set container height */
  .carousel-slide:first-child {
    position: relative;
  }

  .carousel-slide.active {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(0);
  }

  .carousel-slide:hover {
    border-color: var(--border-accent);
    box-shadow: var(--shadow-glow);
  }

  .featured-link {
    display: block;
    padding: var(--space-2xl);
    text-decoration: none;
    color: inherit;
  }

  .featured-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: var(--space-lg);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .category {
    color: var(--accent);
  }

  .divider {
    color: var(--text-dim);
  }

  .featured-title {
    font-family: var(--font-gothic);
    font-size: 2.5rem;
    color: var(--text);
    margin-bottom: var(--space-md);
    line-height: 1.2;
    transition: color 200ms ease;
  }

  .carousel-slide:hover .featured-title {
    color: var(--accent);
  }

  .featured-subtitle {
    font-size: 1.125rem;
    color: var(--text-soft);
    line-height: 1.6;
    margin-bottom: var(--space-lg);
    max-width: 65ch;
  }

  .featured-author {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .author-name {
    color: var(--text-soft);
  }

  .featured-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-xl);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent);
  }

  .indicator-arrow {
    transition: transform 150ms ease;
  }

  .carousel-slide:hover .indicator-arrow {
    transform: translateX(4px);
  }

  .carousel-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--space-lg);
  }

  .carousel-dots {
    display: flex;
    gap: var(--space-sm);
  }

  .carousel-dot {
    width: 8px;
    height: 8px;
    border-radius: 0;
    border: 1px solid var(--border);
    background: transparent;
    cursor: pointer;
    transition: all 200ms ease;
  }

  .carousel-dot:hover {
    border-color: var(--accent);
  }

  .carousel-dot.active {
    background: var(--accent);
    border-color: var(--accent);
  }

  .carousel-nav {
    display: flex;
    gap: var(--space-sm);
  }

  .carousel-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-family: var(--font-mono);
    cursor: pointer;
    transition: all 200ms ease;
  }

  .carousel-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  @media (max-width: 768px) {
    .featured-link {
      padding: var(--space-lg);
    }

    .featured-title {
      font-size: 1.75rem;
    }
  }
</style>
