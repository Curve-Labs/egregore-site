---
const categories = ['All', 'Research', 'Technical', 'Essay', 'Update'];
---

<div class="filters">
  {categories.map((category) => (
    <button
      type="button"
      data-filter={category}
      class:list={['filter-btn', { active: category === 'All' }]}
    >
      {category}
    </button>
  ))}
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    const filterBtns = document.querySelectorAll('[data-filter]');
    const posts = document.querySelectorAll('[data-category]');

    function applyFilter(filter) {
      // Update active state
      filterBtns.forEach(function(b) { b.classList.remove('active'); });
      var activeBtn = document.querySelector('[data-filter="' + filter + '"]');
      if (activeBtn) activeBtn.classList.add('active');

      // Collect posts to show/hide
      var toShow = [];
      var toHide = [];

      posts.forEach(function(post) {
        var category = post.dataset.category;
        var shouldShow = filter === 'All' || category === filter;

        if (shouldShow && post.style.display === 'none') {
          toShow.push(post);
        } else if (!shouldShow && post.style.display !== 'none') {
          toHide.push(post);
        }
      });

      // First, fade out posts that should be hidden
      toHide.forEach(function(post) {
        post.style.transition = 'opacity 150ms ease, transform 150ms ease';
        post.style.opacity = '0';
        post.style.transform = 'translateY(-8px)';
      });

      // After fade out completes, hide them and show new ones
      setTimeout(function() {
        toHide.forEach(function(post) {
          post.style.display = 'none';
        });

        // Now show posts with stagger animation
        var delay = 0;
        toShow.forEach(function(post) {
          post.style.display = '';
          post.style.opacity = '0';
          post.style.transform = 'translateY(8px)';
          post.style.transition = 'none';

          setTimeout(function() {
            post.style.transition = 'opacity 200ms ease, transform 200ms ease';
            post.style.opacity = '1';
            post.style.transform = 'translateY(0)';
          }, delay);
          delay += 30;
        });
      }, 150);
    }

    // Check URL for initial filter
    const urlParams = new URLSearchParams(window.location.search);
    const categoryFromUrl = urlParams.get('category');
    const tagFromUrl = urlParams.get('tag');

    if (tagFromUrl) {
      // Filter by tag instead of category
      applyTagFilter(tagFromUrl);
      // Scroll to archive
      if (window.location.hash === '#archive') {
        const archive = document.getElementById('archive');
        if (archive) {
          setTimeout(function() { archive.scrollIntoView({ behavior: 'smooth' }); }, 100);
        }
      }
    } else if (categoryFromUrl) {
      applyFilter(categoryFromUrl);
      // Scroll to archive if coming from nav link (has hash or category param)
      if (window.location.hash === '#archive') {
        const archive = document.getElementById('archive');
        if (archive) {
          setTimeout(function() { archive.scrollIntoView({ behavior: 'smooth' }); }, 100);
        }
      }
    }

    function applyTagFilter(tag) {
      // Deactivate all category buttons
      filterBtns.forEach(function(b) { b.classList.remove('active'); });

      // Collect posts to show/hide based on tag
      var toShow = [];
      var toHide = [];

      posts.forEach(function(post) {
        var postTags = post.dataset.tags ? post.dataset.tags.split(',') : [];
        var hasTag = postTags.some(function(t) { return t.trim().toLowerCase() === tag.toLowerCase(); });

        if (hasTag && post.style.display === 'none') {
          toShow.push(post);
        } else if (!hasTag && post.style.display !== 'none') {
          toHide.push(post);
        }
      });

      // Animate hide/show
      toHide.forEach(function(post) {
        post.style.transition = 'opacity 150ms ease, transform 150ms ease';
        post.style.opacity = '0';
        post.style.transform = 'translateY(-8px)';
      });

      setTimeout(function() {
        toHide.forEach(function(post) {
          post.style.display = 'none';
        });

        var delay = 0;
        toShow.forEach(function(post) {
          post.style.display = '';
          post.style.opacity = '0';
          post.style.transform = 'translateY(8px)';
          post.style.transition = 'none';

          setTimeout(function() {
            post.style.transition = 'opacity 200ms ease, transform 200ms ease';
            post.style.opacity = '1';
            post.style.transform = 'translateY(0)';
          }, delay);
          delay += 30;
        });
      }, 150);
    }

    // Handle button clicks
    filterBtns.forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const filter = btn.getAttribute('data-filter') || 'All';
        applyFilter(filter);

        // Update URL without reload
        const url = new URL(window.location.href);
        if (filter === 'All') {
          url.searchParams.delete('category');
        } else {
          url.searchParams.set('category', filter);
        }
        history.replaceState(null, '', url.toString());

        return false;
      });
    });
  });
</script>

<style>
  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .filter-btn {
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 400;
    letter-spacing: 0;
    line-height: 16px;
    text-transform: uppercase;
    padding: var(--space-sm) var(--space-md);
    background: transparent;
    border: 1px solid var(--accent);
    border-radius: 0;
    color: var(--accent);
    cursor: pointer;
    transition: all var(--transition-base);
    transform: scale(1);
  }

  .filter-btn:hover {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
    transform: scale(1.02);
  }

  .filter-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
    box-shadow: var(--shadow-glow);
    transform: scale(1);
  }

  .filter-btn:active {
    transform: scale(0.98);
  }
</style>
