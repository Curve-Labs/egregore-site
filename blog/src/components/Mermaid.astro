---
interface Props {
  chart: string;
}

const { chart } = Astro.props;
---

<div class="mermaid-wrapper">
  <pre class="mermaid">{chart}</pre>
</div>

<script>
  import mermaid from 'mermaid';

  function initMermaid() {
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#5bbfb2',
        primaryTextColor: '#e0e0e8',
        primaryBorderColor: '#2a4a46',
        lineColor: '#5a5a6a',
        secondaryColor: '#0f1013',
        tertiaryColor: '#141418',
        background: '#0f1013',
        mainBkg: '#0f1013',
        secondBkg: '#141418',
        textColor: '#e0e0e8',
        nodeTextColor: '#e0e0e8',
        clusterBkg: '#0f1013',
        clusterBorder: '#2a4a46',
        edgeLabelBackground: '#0a0a0c',
        fontFamily: '"Space Mono", monospace',
      },
      flowchart: {
        curve: 'basis',
        padding: 20,
      },
      sequence: {
        diagramMarginX: 20,
        diagramMarginY: 20,
        actorMargin: 50,
        width: 150,
        height: 40,
      },
    });
    mermaid.contentLoaded();
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMermaid);
  } else {
    initMermaid();
  }

  // Re-run on Astro page navigation
  document.addEventListener('astro:after-swap', initMermaid);
</script>

<style>
  .mermaid-wrapper {
    margin: var(--space-xl) 0;
    padding: var(--space-lg);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    overflow-x: auto;
  }

  .mermaid {
    display: flex;
    justify-content: center;
    background: transparent !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Override mermaid's default styling */
  :global(.mermaid svg) {
    max-width: 100%;
    height: auto;
  }

  :global(.mermaid .node rect),
  :global(.mermaid .node circle),
  :global(.mermaid .node ellipse),
  :global(.mermaid .node polygon),
  :global(.mermaid .node path) {
    stroke: var(--border-accent) !important;
    stroke-width: 1px !important;
  }

  :global(.mermaid .edgePath .path) {
    stroke: var(--text-muted) !important;
    stroke-width: 1.5px !important;
  }

  :global(.mermaid .edgeLabel) {
    background-color: var(--bg) !important;
    color: var(--text-soft) !important;
  }
</style>
