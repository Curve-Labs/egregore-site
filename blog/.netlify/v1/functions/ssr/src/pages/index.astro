---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import FeaturedCarousel from '../components/FeaturedCarousel.astro';
import PostRow from '../components/PostRow.astro';
import PostGrid from '../components/PostGrid.astro';
import Filters from '../components/Filters.astro';
import ViewToggle from '../components/ViewToggle.astro';
import Newsletter from '../components/Newsletter.astro';

// Get all posts, filter out drafts, sort by date
const allPosts = (await getCollection('posts', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get featured posts (marked as featured, or top 3 most recent)
const markedFeatured = allPosts.filter(post => post.data.featured);
const featuredPosts = markedFeatured.length > 0 ? markedFeatured : allPosts.slice(0, 3);

// Get remaining posts for the archive
const archivePosts = allPosts.filter(post => !featuredPosts.includes(post));

// Extract unique tags for Explore section
const allTags = Array.from(
  new Set(allPosts.flatMap(post => post.data.tags || []))
).sort();

// Tag descriptions
const tagDescriptions: Record<string, string> = {
  'agents': 'Autonomous software entities capable of perception and action within a shared environment.',
  'knowledge-graphs': 'Semantic networks that structure information into entities and relationships, enabling machine reasoning.',
  'topology': 'The mathematical study of properties preserved through deformations, twistings, and stretchings.',
  'governance': 'Cybernetic control systems for managing collective resources and decision-making processes.',
  'cybernetics': 'The transdisciplinary study of circular causal systems with feedback loops.',
  'scaling': 'Mechanisms for maintaining system coherence as node count increases.',
  'interop': 'Protocols enabling distinct systems to exchange information without friction.',
  'llm': 'Large-scale statistical models capable of generating human-like text and reasoning patterns.',
  'protocol': 'A set of rules governing the exchange or transmission of data between devices.',
  'economics': 'The study of value flows and resource allocation within constrained systems.',
  'theory': 'Abstract frameworks for understanding system dynamics.',
  'ux': 'The interface between human cognition and machine logic.',
  'active-inference': 'A framework where agents minimize free energy by updating internal models to match sensory inputs.',
  'design': 'Intentional creation of structures to solve specific problems.',
  'recursion': 'The process of defining a function or object in terms of itself.',
  'system-design': 'The architecture of complex systems and their inter-dependencies.',
  'ai-agents': 'Artificial intelligence systems designed to act autonomously toward goals.',
  'coordination': 'The organization of different elements of a complex body or activity.',
  'memory': 'Systems for storing and retrieving information across time.',
  'reflection': 'Mechanisms for self-observation and adaptive behavior.'
};

// Group posts by tag for quick lookup
const postsByTag: Record<string, typeof allPosts> = {};
allTags.forEach(tag => {
  postsByTag[tag] = allPosts.filter(post => post.data.tags?.includes(tag));
});
---

<Base
  title="Blog"
  description="Deep dives on knowledge graphs, multi-agent systems, and the infrastructure layer for human–AI collaboration."
  keywords="Curve Labs, knowledge graphs, AI agents, multi-agent systems, distributed systems, cybernetics, protocol design, governance, coordination, active inference"
>
  <div class="container">
    <!-- Header -->
    <header class="page-header">
      <h1 class="page-title">Dispatches</h1>
      <p class="page-desc">Deep dives on knowledge graphs, multi-agent systems, and the infrastructure layer for human–AI collaboration.</p>
    </header>

    <!-- Featured Posts Carousel -->
    {featuredPosts.length > 0 && (
      <section class="featured-section">
        <FeaturedCarousel posts={featuredPosts} />
      </section>
    )}

    <!-- Archive -->
    {archivePosts.length > 0 && (
      <section class="archive-section" id="archive">
        <div class="archive-header">
          <h2 class="archive-title">Archive</h2>
          <div class="archive-controls">
            <Filters />
            <ViewToggle />
          </div>
        </div>

        <!-- List View -->
        <div class="post-list" data-layout="list" style="display: none;">
          {archivePosts.map((post, index) => (
            <PostRow post={post} index={index} />
          ))}
        </div>

        <!-- Grid View (default) -->
        <PostGrid posts={archivePosts} />
      </section>
    )}

    <!-- Explore Terminal -->
    <section class="explore-section" id="explore">
      <div class="explore-header">
        <h2 class="explore-title">Explore</h2>
      </div>

      <div class="explore-grid">
        <!-- Left: Tag Cloud -->
        <div class="tag-cluster">
          {allTags.map((tag) => {
            const count = postsByTag[tag].length;
            return (
              <button
                type="button"
                class="tag-btn"
                data-tag={tag}
                data-count={count}
                data-description={tagDescriptions[tag] || 'Semantic node detected in knowledge base. Analyzing vector relationships...'}
              >
                <span class="tag-hash">#</span>{tag}
              </button>
            );
          })}
        </div>

        <!-- Right: Terminal Screen -->
        <div class="terminal-screen">
          <div class="terminal-header">
            <div class="terminal-header-left">
              <span class="terminal-icon">▸</span>
              <span>/sys/analysis</span>
            </div>
            <div class="terminal-header-right">
              <div class="status-indicator"></div>
              <span id="terminal-status">IDLE</span>
            </div>
          </div>

          <div class="terminal-content">
            <div class="terminal-output" id="terminal-output">
              > SYSTEM READY.<br/>
              > AWAITING INPUT_VECTOR...<br/>
              > SELECT A HASHTAG TO ANALYZE.
            </div>
            <div class="terminal-cursor"></div>

            <div class="terminal-results" id="terminal-results"></div>
          </div>

          <div class="scanlines"></div>
        </div>
      </div>
    </section>

    <!-- Social (placeholder for featured tweets) -->
    <section class="social-section" id="social">
      <h2 class="section-title">Social</h2>
      <p class="section-placeholder">Featured tweets coming soon.</p>
    </section>

    <!-- Connect -->
    <section class="connect-section" id="connect">
      <Newsletter />
    </section>
  </div>
</Base>

<script is:inline define:vars={{ postsByTag }}>
  // Grid view is visible by default, no initial animation needed

  // Explore Terminal
  document.addEventListener('DOMContentLoaded', function() {
    var tagButtons = document.querySelectorAll('.tag-btn');
    var terminalOutput = document.getElementById('terminal-output');
    var terminalResults = document.getElementById('terminal-results');
    var terminalStatus = document.getElementById('terminal-status');
    var statusIndicator = document.querySelector('.status-indicator');
    var cursor = document.querySelector('.terminal-cursor');

    var activeTag = null;
    var isTyping = false;

    function typeText(text, callback) {
      isTyping = true;
      terminalStatus.textContent = 'COMPUTING';
      statusIndicator.classList.add('active');
      cursor.style.display = 'inline-block';

      var index = 0;
      terminalOutput.innerHTML = '';

      var interval = setInterval(function() {
        if (index < text.length) {
          var char = text.charAt(index);
          if (char === '\n') {
            terminalOutput.innerHTML += '<br/>';
          } else {
            terminalOutput.innerHTML += char;
          }
          index++;
        } else {
          clearInterval(interval);
          isTyping = false;
          terminalStatus.textContent = 'IDLE';
          statusIndicator.classList.remove('active');
          cursor.style.display = 'none';
          if (callback) callback();
        }
      }, 15);
    }

    function showResults(tag) {
      var articles = postsByTag[tag] || [];

      if (articles.length === 0) {
        terminalResults.innerHTML = '<div class="no-results">> No published signals found for this node.<br/>> Topic is currently in active research phase.</div>';
      } else {
        var html = '';
        articles.forEach(function(article) {
          var date = new Date(article.data.date);
          var formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

          html += '<a href="/' + article.slug + '/" class="result-item">' +
            '<div class="result-content">' +
              '<span class="result-title">' + article.data.title + '</span>' +
              '<span class="result-meta">' + formattedDate + '</span>' +
            '</div>' +
            '<span class="result-arrow">→</span>' +
          '</a>';
        });
        terminalResults.innerHTML = html;
      }

      terminalResults.style.opacity = '0';
      setTimeout(function() {
        terminalResults.style.transition = 'opacity 300ms ease';
        terminalResults.style.opacity = '1';
      }, 100);
    }

    tagButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (isTyping) return;

        var tag = btn.dataset.tag;
        var count = btn.dataset.count;
        var description = btn.dataset.description;

        // Update active state
        tagButtons.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');

        activeTag = tag;
        terminalResults.innerHTML = '';

        var outputText = '> QUERY: #' + tag.toUpperCase() + '\n' +
          '> DEFINITION: ' + description + '\n' +
          '> SIGNAL_STRENGTH: ' + (count > 0 ? 'HIGH' : 'LATENT') + '\n' +
          '> DETECTED_OBJECTS: ' + count + '\n\n' +
          '> LISTING_RESULTS...';

        typeText(outputText, function() {
          showResults(tag);
        });
      });
    });

    // Check URL for tag parameter and auto-activate
    var urlParams = new URLSearchParams(window.location.search);
    var tagFromUrl = urlParams.get('tag');
    if (tagFromUrl) {
      // Find the corresponding tag button
      var targetBtn = Array.from(tagButtons).find(function(btn) {
        return btn.dataset.tag.toLowerCase() === tagFromUrl.toLowerCase();
      });

      if (targetBtn) {
        // Small delay to ensure page is fully loaded
        setTimeout(function() {
          targetBtn.click();
        }, 300);
      }
    }
  });
</script>

<style>
  .container {
    max-width: 900px;
  }

  .page-header {
    padding: var(--space-3xl) 0 var(--space-2xl);
    text-align: center;
  }

  .page-title {
    font-family: var(--font-gothic);
    font-size: 3.5rem;
    color: var(--text);
    margin-bottom: var(--space-md);
  }

  .page-desc {
    font-size: 1.125rem;
    color: var(--text-soft);
    margin: 0;
  }

  .featured-section {
    margin-bottom: var(--space-3xl);
  }

  .archive-section {
    margin-bottom: var(--space-3xl);
  }

  .archive-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--border);
  }

  .archive-title {
    font-family: var(--font-gothic);
    font-size: 1.5rem;
    color: var(--text);
    margin: 0;
  }

  .archive-controls {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
  }

  .post-list[hidden] {
    display: none;
  }

  .social-section {
    margin-bottom: var(--space-3xl);
    padding: var(--space-2xl) 0;
    border-top: 1px solid var(--border);
  }

  .section-title {
    font-family: var(--font-gothic);
    font-size: 1.5rem;
    color: var(--text);
    margin-bottom: var(--space-lg);
  }

  .section-placeholder {
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 0.875rem;
  }

  .connect-section {
    margin-bottom: var(--space-3xl);
    padding-top: var(--space-2xl);
    border-top: 1px solid var(--border);
  }

  /* Explore Section */
  .explore-section {
    margin-bottom: var(--space-3xl);
    border-top: 1px solid var(--border);
    padding-top: var(--space-3xl);
  }

  .explore-header {
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--border);
  }

  .explore-title {
    font-family: var(--font-gothic);
    font-size: 1.5rem;
    color: var(--text);
    margin: 0;
  }

  .explore-grid {
    display: grid;
    grid-template-columns: 1fr 1.4fr;
    gap: var(--space-3xl);
    align-items: start;
  }

  .tag-cluster {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    align-content: start;
  }

  .tag-btn {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-family: var(--font-mono);
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 200ms ease;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .tag-hash {
    opacity: 0.5;
  }

  .tag-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .tag-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
    font-weight: 700;
    box-shadow: 0 0 20px rgba(91, 191, 178, 0.4);
  }

  .tag-btn.active .tag-hash {
    opacity: 1;
  }

  .terminal-screen {
    background: #000;
    border: 1px solid var(--border-hover);
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    min-height: 400px;
    display: flex;
    flex-direction: column;
  }

  .terminal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--border-hover);
    background: rgba(255, 255, 255, 0.03);
    font-size: 0.625rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
  }

  .terminal-header-left,
  .terminal-header-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .terminal-icon {
    color: var(--accent);
  }

  .status-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--border-hover);
    transition: all 200ms ease;
  }

  .status-indicator.active {
    background: var(--accent);
    animation: pulse 1s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .terminal-content {
    padding: 2rem;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    position: relative;
    z-index: 10;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .terminal-output {
    color: var(--accent);
    white-space: pre-wrap;
    line-height: 1.6;
    font-weight: 300;
    margin-bottom: 2rem;
    min-height: 100px;
  }

  .terminal-cursor {
    display: none;
    width: 8px;
    height: 16px;
    background: var(--accent);
    margin-left: 4px;
    animation: blink 1s step-end infinite;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .terminal-results {
    margin-top: auto;
    border-top: 1px solid rgba(91, 191, 178, 0.1);
    padding-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .result-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    border: 1px solid var(--border-hover);
    background: rgba(255, 255, 255, 0.02);
    text-decoration: none;
    transition: all 200ms ease;
  }

  .result-item:hover {
    border-color: var(--accent);
    background: rgba(91, 191, 178, 0.05);
  }

  .result-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .result-title {
    color: var(--text-soft);
    transition: color 200ms ease;
  }

  .result-item:hover .result-title {
    color: var(--accent);
  }

  .result-meta {
    font-size: 0.625rem;
    color: var(--text-dim);
  }

  .result-arrow {
    color: var(--text-dim);
    transition: all 200ms ease;
  }

  .result-item:hover .result-arrow {
    color: var(--accent);
    transform: translateX(4px);
  }

  .no-results {
    color: var(--text-dim);
    font-size: 0.75rem;
    font-style: italic;
    line-height: 1.6;
  }

  .scanlines {
    position: absolute;
    inset: 0;
    background:
      linear-gradient(rgba(18, 18, 18, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
      linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
    opacity: 0.2;
    z-index: 20;
  }

  @media (max-width: 1024px) {
    .explore-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 2.5rem;
    }

    .archive-header {
      flex-direction: column;
      align-items: stretch;
    }

    .archive-controls {
      justify-content: space-between;
    }

    .terminal-content {
      padding: 1rem;
    }

    .terminal-output {
      font-size: 0.75rem;
    }
  }
</style>
